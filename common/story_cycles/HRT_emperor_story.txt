HRT_emperor_story = {

	on_setup = {
		story_owner = {
			#To scope to emperor
			title:c_aachen = {
				set_variable = {
					name = HRT_emperor
					value = scope:story.story_owner
				}
			}
			set_variable = {
				name = HRT_authority
				value = 0
			}
			set_variable = {
				name = HRT_authority_prestige
				value = prestige
			}
			set_variable = {
				name = HRT_authority_dread
				value = dread
			}
			set_variable = {
				name = HRT_authority_years_reigned
				value = 0
			}
			set_variable = {
				name = HRT_authority_vassals_var
				value = 0
			}
			set_variable = {
				name = HRT_authority_vassals_bonus_var
				value = 0
			}
			set_variable = {
				name = HRT_authority_vassals_war_var
				value = 0
			}
			set_variable = {
				name = HRT_authority_infidels_var
				value = 0
			}
			set_variable = {
				name = HRT_authority_territory
				value = 0
			}
			set_variable = {
				name = HRT_authority_unheld_heartlands
				value = 0
			}
			set_variable = {
				name = HRT_authority_military_strength
				value = max_military_strength
			}
			set_variable = {
				name = HRT_authority_ally_military_strength
				value = 0
			}
			set_variable = {
				name = HRT_authority_artifacts
				value = 0
			}
			if = {
				limit = { exists = global_var:Trinity_is_loaded }
				set_variable = {
					name = HRT_authority_cardinals
					value = 0
				}
			}

			#Coronation
			if = {
				limit = {
					NOR = {
						has_trait = HRT_emperor
						has_trait = COR_crowned_by_myself
					}
				}
				if = {
					limit = { has_variable = COR_coronator }
					remove_variable = COR_coronator
				}
				if = {
					limit = {
						NOT = { has_variable = COR_years_reigned }
					}
					set_variable = {
						name = COR_years_reigned
						value = 0
					}
				}
				if = {
					limit = { has_game_rule = COR_crowns_taketh }
					add_character_flag = sold_crown_charmod
					every_spouse = {
						limit = {
							NOR = {
								has_trait = COR_crowned_by_priest
								has_trait = COR_crowned_by_bishop
								has_trait = COR_crowned_by_pope
								has_trait = COR_crowned_by_myself
								has_trait = HRT_emperor
								has_trait = COR_byz_crowned_by_patriarch
							}
						}
						add_character_flag = sold_crown_charmod
					}
				}
			}

			#Nibelungen
			if = {
				limit = {
					exists = dynasty # just in case
					dynasty = {
						NOT = { has_variable = HRT_edicts_issued }
					}
				}
				dynasty = {
					set_variable = {
						name = HRT_edicts_issued
						value = 0
					}
				}
			}

			# 2.2 Unity
			if = {
				limit = { exists = title:e_hre.holder }
				trigger_event = {
					id = HRT.2100
					days = 1
				}
			}
		}
	}
	
	on_owner_death = {
		HRT_close_window = yes
		title:c_aachen = {
			set_variable = {
				name = HRT_deceasedemperor
				value = scope:story.story_owner
			}
		}
		story_owner = {
			primary_heir ?= {
				set_variable = {
					name = HRT_prince_var
					value = yes
					days = 1
				}
			}
			player_heir ?= {
				trigger_event = { id = HRT.9005 days = 1 }
			}
			HRT_initialize_succession = yes
		}
		end_story = yes
	}

	on_end = {
		story_owner = {
			if = {
				limit = { is_alive = yes }
				remove_variable = HRT_authority
				remove_variable = HRT_authority_prestige
				remove_variable = HRT_authority_dread
				remove_variable = HRT_authority_years_reigned
				remove_variable = HRT_authority_vassals_var
				remove_variable = HRT_authority_vassals_bonus_var
				remove_variable = HRT_authority_vassals_war_var
				remove_variable = HRT_authority_infidels_var
				remove_variable = HRT_authority_territory
				remove_variable = HRT_authority_unheld_heartlands
				remove_variable = HRT_authority_military_strength
				remove_variable = HRT_authority_ally_military_strength
				remove_variable = HRT_authority_artifacts
				remove_variable = HRT_authority_cardinals
				remove_variable = HRT_authority_unity

				remove_character_modifier ?= HRT_edict_legal_unification
				remove_character_modifier ?= HRT_edict_chivalric_excellence
				remove_character_modifier ?= HRT_edict_diplomatic_corps
				remove_character_modifier ?= HRT_edict_consular_taxation
				remove_character_modifier ?= HRT_edict_urban_rights
				remove_character_modifier ?= HRT_edict_border_defense
				remove_character_modifier ?= HRT_edict_scholastic_advancement
				remove_character_modifier ?= HRT_edict_imperial_works
				remove_character_modifier ?= HRT_edict_ecclesiastical_patronage

				remove_character_modifier ?= HRT_edict_proclaim_directive_diplomacy
				remove_character_modifier ?= HRT_edict_proclaim_directive_martial
				remove_character_modifier ?= HRT_edict_proclaim_directive_stewardship
				remove_character_modifier ?= HRT_edict_proclaim_directive_intrigue
				remove_character_modifier ?= HRT_edict_proclaim_directive_learning

				remove_character_modifier ?= HRT_preparing_for_unification_war

				remove_character_modifier ?= HRT_unity_festival
				remove_character_modifier ?= HRT_unity_marriage
				remove_character_modifier ?= HRT_unity_contracts
				remove_character_modifier ?= HRT_unity_trade

				remove_character_modifier ?= HRT_hoftag_gather_support_mod
			}
			if = {
				limit = {
					this ?= title:c_aachen.var:HRT_emperor
				}
				title:c_aachen = { remove_variable = HRT_emperor }
			}
		}
	}

	effect_group = {
		months = 1
		triggered_effect = {
			trigger = {
				always = yes
			}
			effect = {
				story_owner = {
					#Reset Variables
					change_variable = {
						name = HRT_authority_vassals_var
						multiply = 0
					}
					change_variable = {
						name = HRT_authority_vassals_bonus_var
						multiply = 0
					}
					change_variable = {
						name = HRT_authority_vassals_war_var
						multiply = 0
					}
					change_variable = {
						name = HRT_authority_infidels_var
						multiply = 0
					}
					change_variable = {
						name = HRT_authority_territory
						multiply = 0
					}
					change_variable = {
						name = HRT_authority_unheld_heartlands
						multiply = 0
					}
					change_variable = {
						name = HRT_authority_ally_military_strength
						multiply = 0
					}
					change_variable = {
						name = HRT_authority_artifacts
						multiply = 0
					}
					if = {
						limit = { exists = var:HRT_authority_cardinals }
						change_variable = {
							name = HRT_authority_cardinals
							multiply = 0
						}
					}

					#Prestige Bonus
					set_variable = {
						name = HRT_authority_prestige
						value = prestige
					}
					#Dread Bonus
					set_variable = {
						name = HRT_authority_dread
						value = dread
					}
					#Vassal Values
					every_vassal = {
						#Total Vassal Count
						prev = {
							change_variable = {
								name = HRT_authority_vassals_var
								add = 1
							}
						}
						#Vassal Bonus per Tier
						if = {
							limit = { highest_held_title_tier = tier_kingdom }
							prev = {
								change_variable = {
									name = HRT_authority_vassals_bonus_var
									add = authority_gain_per_vassal_kingdom_bonus
								}
							}
						}
						else_if = {
							limit = { highest_held_title_tier = tier_duchy }
							prev = {
								change_variable = {
									name = HRT_authority_vassals_bonus_var
									add = authority_gain_per_vassal_duchy_bonus
								}
							}
						}
						#Vassals Waging War Malus
						if = {
							limit = { is_at_war = yes }
							prev = {
								change_variable = {
									name = HRT_authority_vassals_war_var
									add = authority_loss_per_waged_vassal_war
								}
							}
						}
						#Infidel Vassal Malus
						if = {
							limit = { NOT = { faith = prev.faith } }
							prev = {
								change_variable = {
									name = HRT_authority_infidels_var
									add = 1
								}
							}
						}
					}
					#Territory Bonus
					every_realm_county = {
						prev = {
							change_variable = {
								name = HRT_authority_territory
								add = 1
							}
						}
					}
					#Unheld Heartlands Malus
					every_county_in_region = {
						region = HRT_core_territory
						limit = {
							holder.top_liege = {
								NOT = { this = scope:story.story_owner }
							}
						}
						prev = {
							change_variable = {
								name = HRT_authority_unheld_heartlands
								add = 1
							}
						}
					}
					#Ally Bonus
					set_variable = {
						name = HRT_authority_military_strength
						value = max_military_strength
					}
					every_ally = {
						save_temporary_scope_as = ally
						prev = {
							change_variable = {
								name = HRT_authority_ally_military_strength
								add = scope:ally.max_military_strength
							}
						}
					}
					#Artifact Bonus
					every_character_artifact = {
						limit = { rarity = illustrious }
						prev = {
							change_variable = {
								name = HRT_authority_artifacts
								add = 0.1
							}
						}
					}
					#Cardinals Bonus
					if = {
						limit = { exists = var:HRT_authority_cardinals }
						every_living_cardinal = {
							limit = { is_vassal_or_below_of = prev }
							prev = {
								change_variable = {
									name = HRT_authority_cardinals
									add = 1
								}
							}
						}
					}

					#2.5 Reichsstadt
					title:c_aachen = {
						if = {
							limit = { has_variable_list = HRT_reichsstaedte }
							every_in_list = {
								variable = HRT_reichsstaedte
								set_variable = {
									name = HRT_reichsstadt_development
									value = development_level
								}
							}
						}
					}

					#Prevent exceeding authority range (0-100)
					if = {
						limit = { HRT_authority_limiter_value <= 0 }
						set_variable = {
							name = HRT_authority
							value = 0
						}
					}
					else_if = {
						limit = { HRT_authority_limiter_value >= 100 }
						set_variable = {
							name = HRT_authority
							value = 100
						}
					}
					#Apply Monthly Authority Change
					else = {
						change_variable = {
							name = HRT_authority
							add = HRT_authority_change_value
						}
					}
				}

				#Pope opinion of candidati parked here to prevent errors, sorry
				if = {
					limit = {
						NOT = { exists = title:e_hre.holder }
					}
					every_HRT_candidati = {
						save_scope_as = HRT_candidatus
						faith:catholic.religious_head ?= {
							if = {
								limit = {
									save_temporary_opinion_value_as = {
										name = popinion
										target = scope:HRT_candidatus
									}
									exists = scope:popinion
								}
								scope:HRT_candidatus = {
									set_variable = {
										name = HRT_popinion
										value = scope:popinion
									}
								}
							}
						}
					}
				}

			}
		}
	}

	#AI enacting edicts (top notch AI decision making)
	effect_group = {
		months = 3
		triggered_effect = {
			trigger = {
				story_owner = {
					is_ai = yes
					HRT_authority_progressbar_value >= 100
				}
			}
			effect = {
				story_owner = {
					if = {
						limit = {
							culture = { has_cultural_era_or_later = culture_era_late_medieval }
						}
						random_list = {
							10 = {
								trigger_event = HRT_edicts.0001 # Edict of Legal Unification
							}
							10 = {
								trigger_event = HRT_edicts.0004 # Consular Taxation Directive
							}
							10 = {
								modifier = {
									add = 90
									is_at_war = yes
								}
								trigger_event = HRT_edicts.0002 # Imperial Decree of Chivalric Excellence
							}
							10 = {
								trigger_event = HRT_edicts.0009 # Edict of Imperial Works
							}
							10 = {
								trigger_event = HRT_edicts.0008 # Edict of Scholastic Advancement
							}
							10 = {
								trigger_event = HRT_edicts.0010 # Edict of Ecclesiastical Patronage
							}
							10 = {
								trigger_event = HRT_edicts.0003 # Diplomatic Corps Activation Edict
							}
							10 = {
								trigger_event = HRT_edicts.0006 # Edict of Urban Rights and Privileges
							}
							10 = {
								modifier = {
									add = 90
									is_at_war = yes
								}
								trigger_event = HRT_edicts.0005 # Imperial Levy Conscription Order
							}
							10 = {
								modifier = {
									add = 90
									is_at_war = yes
								}
								trigger_event = HRT_edicts.0007 # Border Defense Temporary Directive
							}
						}
					}
					else_if = {
						limit = {
							culture = { has_cultural_era_or_later = culture_era_high_medieval }
						}
						random_list = {
							10 = {
								trigger_event = HRT_edicts.0001 # Edict of Legal Unification
							}
							10 = {
								trigger_event = HRT_edicts.0004 # Consular Taxation Directive
							}
							10 = {
								modifier = {
									add = 90
									is_at_war = yes
								}
								trigger_event = HRT_edicts.0002 # Imperial Decree of Chivalric Excellence
							}
							10 = {
								trigger_event = HRT_edicts.0009 # Edict of Imperial Works
							}
							10 = {
								trigger_event = HRT_edicts.0008 # Edict of Scholastic Advancement
							}
							10 = {
								trigger_event = HRT_edicts.0010 # Edict of Ecclesiastical Patronage
							}
						}
					}
					else_if = {
						limit = {
							culture = { has_cultural_era_or_later = culture_era_early_medieval }
						}
						random_list = {
							30 = {
								trigger_event = HRT_edicts.0001 # Edict of Legal Unification
							}
							30 = {
								trigger_event = HRT_edicts.0004 # Consular Taxation Directive
							}
							5 = {
								trigger_event = HRT_edicts.1001 # Proclamation of Imperial Directive
							}
						}
					}
					else = { trigger_event = HRT_edicts.1001 } # Proclamation of Imperial Directive
				}
			}
		}
	}

	effect_group = {
		years = 2
		triggered_effect = {
			trigger = {
				story_owner = {
					is_ai = yes
					is_at_war = no
					HRT_authority_progressbar_value >= 75
				}
			}
			effect = {
				story_owner = {
					if = {
						limit = {
							culture = { has_cultural_era_or_later = culture_era_late_medieval }
						}
						random_list = {
							10 = {
								trigger_event = HRT_edicts.0001 # Edict of Legal Unification
							}
							10 = {
								trigger_event = HRT_edicts.0004 # Consular Taxation Directive
							}
							10 = {
								trigger_event = HRT_edicts.0009 # Edict of Imperial Works
							}
							10 = {
								trigger_event = HRT_edicts.0008 # Edict of Scholastic Advancement
							}
							10 = {
								trigger_event = HRT_edicts.0010 # Edict of Ecclesiastical Patronage
							}
							10 = {
								trigger_event = HRT_edicts.0003 # Diplomatic Corps Activation Edict
							}
							10 = {
								trigger_event = HRT_edicts.0006 # Edict of Urban Rights and Privileges
							}
							5 = {
								trigger_event = HRT_edicts.1001 # Proclamation of Imperial Directive
							}
							30 = { }
						}
					}
					else_if = {
						limit = {
							culture = { has_cultural_era_or_later = culture_era_high_medieval }
						}
						random_list = {
							10 = {
								trigger_event = HRT_edicts.0001 # Edict of Legal Unification
							}
							10 = {
								trigger_event = HRT_edicts.0004 # Consular Taxation Directive
							}
							10 = {
								trigger_event = HRT_edicts.0009 # Edict of Imperial Works
							}
							10 = {
								trigger_event = HRT_edicts.0008 # Edict of Scholastic Advancement
							}
							10 = {
								trigger_event = HRT_edicts.0010 # Edict of Ecclesiastical Patronage
							}
							5 = {
								trigger_event = HRT_edicts.1001 # Proclamation of Imperial Directive
							}
							20 = { }
						}
					}
					else_if = {
						limit = {
							culture = { has_cultural_era_or_later = culture_era_early_medieval }
						}
						random_list = {
							30 = {
								trigger_event = HRT_edicts.0001 # Edict of Legal Unification
							}
							30 = {
								trigger_event = HRT_edicts.0004 # Consular Taxation Directive
							}
							5 = {
								trigger_event = HRT_edicts.1001 # Proclamation of Imperial Directive
							}
							10 = { }
						}
					}
					else = {
						random_list = {
							10 = {
								trigger_event = HRT_edicts.1001  # Proclamation of Imperial Directive
							}
							40 = { }
						}
					}
				}
			}
		}
	}

	effect_group = {
		years = 3
		triggered_effect = {
			trigger = {
				story_owner = {
					is_ai = yes
					is_at_war = no
					HRT_authority_progressbar_value >= 50
				}
			}
			effect = {
				story_owner = {
					if = { # 2.3 Hoftag
						limit = {
							exists = title:e_hre.holder
							NOR = {
								has_character_flag = HRT_held_hoftag
								has_character_flag = HRT_preparing_hoftag
								has_variable = HRT_convening_hoftag
							}
							var:HRT_authority_years_reigned > 8
						}
						trigger_event = HRT_hoftag.0001
					}
					if = {
						limit = {
							culture = { has_cultural_era_or_later = culture_era_high_medieval }
						}
						random_list = {
							10 = {
								trigger_event = HRT_edicts.0001 # Edict of Legal Unification
							}
							10 = {
								trigger_event = HRT_edicts.0010 # Edict of Ecclesiastical Patronage
							}
							20 = { }
						}
					}
					else_if = {
						limit = {
							culture = { has_cultural_era_or_later = culture_era_early_medieval }
						}
						random_list = {
							10 = {
								trigger_event = HRT_edicts.0001 # Edict of Legal Unification
							}
							10 = { }
						}
					}
					else = {
						random_list = {
							10 = {
								trigger_event = HRT_edicts.1001  # Proclamation of Imperial Directive
							}
							40 = { }
						}
					}
				}
			}
		}
	}

	effect_group = { # Put everything related to maintenance here
		years = 1
		triggered_effect = {
			trigger = { always = yes }
			effect = {
				story_owner = {
					change_variable = {
						name = HRT_authority_years_reigned
						add = 1
					}

					if = {
						limit = { exists = title:e_hre.holder }
						trigger_event = HRT.2100 # Unity Effect
						# 2.5 Reichsstadt
						title:c_aachen = {
							if = {
								limit = { has_variable_list = HRT_reichsstaedte }
								every_in_list = {
									variable = HRT_reichsstaedte
									change_variable = {
										name = HRT_reichsstadt_years
										add = 1
									}
									if = {
										limit = {
											var:HRT_reichsstadt_years >= 15
											has_county_modifier = HRT_reichsstadt_1
										}
										remove_county_modifier = HRT_reichsstadt_1
										add_county_modifier = HRT_reichsstadt_2
									}
									else_if = {
										limit = {
											var:HRT_reichsstadt_years >= 30
											has_county_modifier = HRT_reichsstadt_2
										}
										remove_county_modifier = HRT_reichsstadt_2
										add_county_modifier = HRT_reichsstadt_3
									}
								}
							}
						}
					}

					# Misc Backup
					if = {
						limit  = {
							NOT = { has_title = title:e_hre }
						}
						if = {
							limit = {
								OR = {
									exists = title:e_hre.holder # someone else restored the hre
									highest_held_title_tier = tier_empire # you restored an empire that is not the hre, well done
									is_landed = no
									#Faith conditions.
									this = faith.religious_head
									NOT = {
										faith = { religion_tag = christianity_religion }	
									}
									AND = {	#No need for a competing empire if your faith controls the ERE.
										exists = title:e_byzantium.holder
										faith = title:e_byzantium.holder.faith
									}
									#Government conditions.
									NOR = {
										government_has_flag = government_is_feudal
										government_has_flag = government_is_clan
									}
								}
							}
							HRT_close_window = yes
							#TODO add notification
							if = {
								limit = {
									highest_held_title_tier = tier_empire
									NOT = { exists = title:e_hre.holder }
								}
								title:c_aachen = {
									set_variable = {
										name = HRT_dismantled
										value = yes
									}
								}
							}
							if = {
								limit = { exists = title:e_hre.holder }
								title:e_hre.holder = {
									if = {
										limit = {
											NOT = { this = faith.religious_head }
											faith = { religion_tag = christianity_religion }
											OR = {
												government_has_flag = government_is_feudal
												government_has_flag = government_is_clan
											}
										}
										create_story = HRT_emperor_story
										if = {
											limit = {
												NOT = { has_character_flag = HRT_italienzug }
											}
											trigger_event = {
												id = HRT.1001
												days = { 7 14 }
											}
										}
									}
								}
							}
							else_if = {
								limit = {
									NOT = { highest_held_title_tier = tier_empire }
								}
								ordered_HRT_candidati = {
									order_by = HRT_imperator_score
									position = 0
									save_temporary_scope_as = HRT_new_emperor
									create_story = HRT_emperor_story
									if = {
										limit = {
											NOT = { has_character_flag = HRT_italienzug }
										}
										trigger_event = {
											id = HRT.1001
											days = { 7 14 }
										}
									}
								}
							}
							# Kill current emperor's story
							random_owned_story = {
								limit = { story_type = HRT_emperor_story }
								end_story = yes
							}
						}
					}
				}
			}
		}
	}

	#Trigger Coronation when leading an army in Rome
	effect_group = {
		weeks = 1
		triggered_effect = {
			trigger = {
				story_owner = {
					is_ai = no
					NOR = {
						has_trait = COR_crowned_by_myself
						has_trait = HRT_emperor
					}
				}
			}
			effect = {
				story_owner = {
					if = {
						limit = {
							NOT = { has_variable = HRT_declined_travel_coronation }
							is_commanding_army = yes
							OR = {
								has_character_flag = HRT_italienzug
								has_variable = COR_years_reigned
							}
							has_variable = COR_coronator
							var:COR_coronator = faith:catholic.religious_head
							exists = faith:catholic.religious_head.capital_province
							location = faith:catholic.religious_head.capital_province
						}
						location = { save_scope_as = location }
						trigger_event = HRT.1102
					}
				}
			}
		}
	}
}